```{r}
library(readr)
library(ggplot2)
library(dplyr)
library(tidymodels)
library(rjson)
library(stringr)
tidymodels_prefer()
```

```{r}
stringency_data <- read.csv('covid-stringency-index.csv')
all_data <- read.csv('owid-covid-data.csv')
```

```{r}
isl_swe_data <- all_data %>%
  filter(iso_code=="SWE"|iso_code=='ISL')
```

```{r}
all_data %>%
  ggplot(aes(x=date,y=new_cases_smoothed_per_million, color=continent)) +
  geom_point()
```

```{r}
lm_spec <-
    linear_reg() %>% 
    set_engine(engine = 'lm') %>% 
    set_mode('regression')
```

```{r}
mod1 <- fit(lm_spec,
            total_deaths ~ stringency_index + population, 
            data = all_data)

mod1 %>%
  pluck()
```

```{r}
what_questions_are = read.csv(file = 'what_questsions_are.csv')
what_answer_codes_mean = read.csv(file = 'what_answer_codes_mean.csv')
country_code_data = read.csv(file = "country_code_data.csv")
mean_data = fromJSON(file="mean_data_per_country.json")
get_full_name <- function(abv) {
  to_ret <- (country_code_data %>% filter(Code==abv))$Name
  return(to_ret)
}
```

```{r}
#data_index = fromJSON(file='data_index_orient.json')
data_index = fromJSON(file='data_with_dates.json')
```

```{r}
countries = c('SE','IT','UK','US','AU','DE','ES','MX','JP','KR','CN')
country = 'IT'
quest = 'CanadaQ_2'
country_full_name = (country_code_data %>% filter(Code==country))$Name
```

# single plot
```{r}

put_new_lines <- function(string, num_chars) {
  if (nchar(string) <= num_chars) {
    return(string)
  }
  for (i in num_chars:nchar(string)) {
    if (substr(string,i,i) == " ") {
      first = substr(string, 1, i)
      last = substr(string, i, nchar(string))
      if (nchar(last) >= num_chars) {
        last = put_new_lines(last, num_chars)
      }
      new_string <- paste(first, "\n", last)
      return(new_string)
    }
  }
}

question_text <- what_questions_are %>%
  filter(var==quest) %>%
  select('question')

code_text <- what_answer_codes_mean %>%
  filter(var==quest) %>%
  select('code', 'label')

to_plot <- data_index[[quest]][[country]] %>%
  as.numeric() %>%
  data.frame()

to_plot$lab <- code_text$label[match(to_plot$.,code_text$code)]

labels = vector()
to_paste <- ""
for (i in 1:max(code_text$code)){
  to_paste = if (i%%2) "" else "\n \n"
  if (i %in% code_text$code) {
    labels <- c(labels, paste(to_paste,put_new_lines(code_text[code_text$code==i,]$label,13)))
  } else {
    labels <- c(labels, i)
  }
}

title <- put_new_lines(question_text[question_text != "",], 76)

average_date = data_index[['EndDate']][[country]]
average_date = as.Date(as.POSIXct(average_date, origin="1970-01-01"))
average_date = substr(average_date,6,11)
average_date = paste("2020",average_date,sep = "")

stringency = (stringency_data %>%
  filter(Entity == country_full_name) %>%
  filter(Day == average_date))$stringency_index

print(stringency)

to_plot%>%
  ggplot(aes(x=.))+
    stat_count() +
    scale_x_discrete(limits=labels,labels=labels) +
    labs(title=title)
```

# multi plot
```{r}
d1 <- mean_data[[quest]] %>%
  data.frame()
d1 <- data.frame(country=names(d1),avg=t(d1)) %>%
  mutate(country = gsub(".", " ", country, fixed=TRUE))
  
#ggplot(mean_data, aes(x=CanadaQ_2,y=))
```


